\documentclass[12pt,twocolumn]{article}
\usepackage{times}
\usepackage{array}
\usepackage{booktabs}
\usepackage{charsheet}
\usepackage{soul}
\usepackage{multicol}
\usepackage{enumitem}

\newcolumntype{e}{>{\itshape}l}

\pagestyle{empty}
\parindent=0pt
\newcommand\bigstrut{\vrule width 0pt height 12pt}
\newcommand\X{\leavevmode\bigstrut}
\newcommand\deepstrut{\vrule width 0pt depth 5pt}
\newcommand\Y{\deepstrut}

\newcommand\vfilbreak[1][3\baselineskip]{\vskip 0pt plus #1\penalty-200 \vskip 0pt plus -#1}

\makeatletter

\let\expandArg=\@expandArg

\newenvironment{gmproflist}
  {\clubpenalty=10000
   \widowpenalty=10000
   \begin{list}{}{%
      \advance\@itemdepth\@ne
      \raggedright
      \setlength{\leftmargin}{10pt}% hanging indentation
      \setlength{\itemindent}{-10pt}%
      \setlength{\labelwidth}{0pt}%
      \setlength{\labelsep}{0pt}%
      \setlength{\topsep}{0pt}% space before/after the list
      \setlength{\partopsep}{0pt}%
      \setlength{\parsep}{0pt}%
      \setlength{\itemsep}{1pt}% space between items
      \renewcommand*{\makelabel}[1]{}% suppress the bullet
      \baselineskip=13pt
  }}%
  {\end{list}}

\newcommand\setpassive[2]{%
  \expandafter\def\csname passive@#1\endcsname{#2}%
}
\newcommand\usepassive[1]{%
  \csname passive@#1\endcsname
}
\newcommand\whenpassive[2]{%
  \@ifundefined{passive@#1}{}{#2}%
}

\makeatother

%% regexp-based editing commands

\ExplSyntaxOn
\DeclareRobustCommand{\supE}[1]{\nr_supE:n { #1 }}

\cs_new_protected:Nn \nr_supE:n
  {
    \tl_set:Nn \l_tmpa_tl { #1 }
    % Replace every literal space + [E] with a superscript E, math-safe
    \regex_replace_all:nnN { \ \[E\] } { \c{mysuperE} } \l_tmpa_tl
%    \tl_use:N \l_tmpa_tl
    \l_tmpa_tl
  }
\ExplSyntaxOff



\ExplSyntaxOn
\NewDocumentCommand{\endwithperiod}{m}{\nr_end_with_period:n { #1 }}

\cs_new_protected:Nn \nr_end_with_period:n
  {
    \tl_set:Nn \l_tmpa_tl { #1 }
    % Trim trailing explicit spaces, ties (~), and control-space (\ )
    \regex_replace_once:nnN { (?:\s|~|\\ )+\Z } {} \l_tmpa_tl
    % If it (now) ends with a dot, remove it
    \regex_replace_once:nnN { \.\Z } {} \l_tmpa_tl
    % Add exactly one dot
    \tl_use:N \l_tmpa_tl .
  }
\ExplSyntaxOff

\newcommand\regexpVar[2]{% apply command to tokens stored in var
   \expandArg{\expandArg{\expandArg#1}}{\rawgetDND{#2}}%
}

\newcommand\mysuperE{\rlap{\textsuperscript{E}}}


\newcommand\showstat[2]{% Str STR % get modifier, saving bonus
   \ifDNDnonempty{#2}{%
     \expandafter\setstatnumber\expandafter{\rawgetDND{#2}}%
     \pgfmathsetcounter{statmod}{floor((\value{statnumber} - 10) / 2)}%
     \textrm{\small\textsc{#1}}\,\ensuremath{\signedmath{\value{statmod}}\saving{#2}}%
   }{%
     \textrm{\small\textsc{#1}}\,??
   }%
}

\newcommand\saving[1]{%
  \whenDNDtrue{#1 SAVING}{{}^*}%
}

\newcounter{profscounter}  % counts groups of proficiencies
\def\gobbleprofs#1\end{\end}%

\newcommand\commasep[1]{%
  \begingroup
    \def\bonus{\def\bonus{, }}%
    \def\reaction{\def\reaction{, }}%
    #1%
  \endgroup
}

\newcommand\showplayer[1]{%
  \begingroup
    \tabcolsep=4pt
    \useDNDplayer{#1}%
    \vskip 1.0\baselineskip plus 0.4\baselineskip minus 0.6\baselineskip
    \begin{tabular}{|>{\raggedright \arraybackslash}p{\hsize-2\tabcolsep}|}
    \multicolumn1{l}{%
      \getDND*{CLASS} \emph{\getDND*{CHARACTER NAME}}
      (\getDND*{RACE})
    }%
    \\
    \hline
    \X
    \getDND*{DESCRIPTION}\Y
    \\
    \hline
    \X
  \begingroup
    \newcommand\myspace{\hskip 1em minus 5pt}%
    \hbox to \hsize{%
      \showstat{Str}{STR}\myspace
      \showstat{Dex}{DEX}\myspace
      \showstat{Con}{CON}\myspace
      \showstat{Int}{INT}\myspace
      \showstat{Wis}{WIS}\myspace
      \showstat{Cha}{CHA}%
     }%
  \endgroup
    \\
    \hline
    \begingroup
      \vspace*{-9pt}%
      \raggedcolumns
      \setcounter{profscounter}{0}
      \multicolsep=0pt
      \columnsep=3pt
      \def\profskip{%
         \let\profsnext\relax
         \ifcase\value{profscounter}
             \end{gmproflist}\end{multicols}%
             \par\medskip
             \stepcounter{profscounter}%
             \begin{multicols}{3}\begin{gmproflist}
             \def\profsnext{}%\relax
         \or
             \stepcounter{profscounter}%
             \def\profsnext{}%
         \or
             \def\profsnext{\gobbleprofs}%
         \fi
         \profsnext
      }%
      \scshape
      \begin{multicols}{3}
      \rightskip 0pt plus -3em  % cheat into right margin
      \begin{gmproflist}
      \regexpVar\supE{PROFICIENCIES}%
      \end{gmproflist}
      \end{multicols}
    \endgroup
    \\
    \hline
    \X
    \whenDNDnonempty{SENSES}{\regexpVar\endwithperiod{SENSES} }%
    \whenDNDnonempty{SPELL DC}{Spell~DC~\getDND{SPELL DC}. }%
    \whenDNDnonempty{ARMOR CLASS}{AC~\getDND{ARMOR CLASS}. }%
    \whenDNDnonempty{BACKGROUND}{\getDND{BACKGROUND}. }%
    \\
    \whenDNDnonempty{BONUS ACTIONS}{%
       \hangindent=1em \hangafter=1
       \textbf{Bonus Actions:} \commasep{\getDND{BONUS ACTIONS}}.\par\\}%
    \whenDNDnonempty{REACTIONS}{%
       \hangindent=1em \hangafter=1
       \textbf{Reactions:} \commasep{\getDND{REACTIONS}}.\par\\}%
    \whenDNDnonempty{GM NOTES}{\getDND{GM NOTES}\\}%
    \whenDNDnonempty{MOTIVATION}{\emph{Motivation: \getDND{MOTIVATION}.}\\}%
    \hline
    \end{tabular}%
  \endgroup
}


\input{stats} % loads data on players plus group data

\columnsep=15pt

\begin{document}

\raggedright

\whenDNDplayer1{\showplayer1}

\whenDNDplayer2{\showplayer2}

\medskip

\newcommand\showpassive[1]{%
  \whenpassive{#1}{%
    \par\bigskip
    \begingroup
      \def\skillrow##1##2{##1&(##2)\\}%
      \noindent Passive #1s:\\
      \begin{tabular}{@{\quad}r@{~}l@{}}
      \usepassive{#1}%
      \end{tabular}
    \endgroup
  }%
}

\showpassive{Perception}
\showpassive{Insight}


\newpage

\whenDNDplayer3{\showplayer3}

\whenDNDplayer4{\showplayer4}

\bigskip

\newcommand\C{\/\upshape{[C]}}

\newcommand\durablestable[2]{%
  \begingroup
    \def\durable##1##2{##1&##2\\}%
    \begin{tabular}{@{}ll@{}}
      \begin{tabular}[t]{@{}el@{}}
         #1
      \end{tabular}
      &
      \begin{tabular}[t]{@{}el@{}}
         #2
      \end{tabular}
      \\
    \end{tabular}
  \endgroup
}

\newcommand\?{\phantom{1}}

\emph{\Large Durable Effects}
\par
\medskip
\expandafter\durablestable\durables % \durables set in stats, two columns

\bigskip

\emph{\large Offensive Spells and Features}
\par
\medskip
\noindent
\begingroup
  \def\attack#1{#1\\}%
  \def\savespell#1#2{#1 \upshape(#2)\\}%
  \begin{tabular}{@{}c@{}}
  \toprule
  \begin{tabular}[t]{@{}e}
  \upshape{Attack roll}\\
  \midrule
  \spellattacks
  \end{tabular}%
  \begin{tabular}[t]{e}
  \upshape{Saving throw}\\
  \midrule
  \spellsaves
  \end{tabular}\\
  \bottomrule
  \end{tabular}
\endgroup


\begingroup
\medskip
\parskip=0pt
\parindent=0pt

%L2 Sorcerer: 3~known, 4~cantrips, 3~spells, 2~sorcery points
%
%L2 Cleric: 3~cantrips, 5~choice spells, 2~domain spells (Bless, Cure Wounds)
%
%\medskip

%%L1 Druid: 4~known, 4~cantrips, 4~L1~spells, 2~L2~spells, 3~sorcery
%%points
%%
%%\hangindent=30pt
%%L3 Cleric: 3~cantrips, 6~choice spells, 4~domain spells (Bless, Cure
%%Wounds, Lesser Restoration, Spiritual Weapon)

\endgroup

\end{document}

